<html>
<head>
    <meta charset="utf-8" />
    <title>TrazZzer</title>
</head>
<body onload="draw();">
<canvas id="canvas" width="600" height="600" style="border: 1px solid black; background: black"></canvas>
</body>
<script>

    var players = {
        currentPlayers: [
            {
                id: 1,
                name: "player1",
                color: "#28BA3C",
                frags: 1,
                owned: 2
            },
            {
                id: 2,
                name: "player2",
                color: "#0A94FF",
                frags: 2,
                owned: 1
            }
        ]
    };

    var gameState = {
        height: 3,
        width: 3,
        bikes: [
            {
                playerId: 1,
                direction: 'W',
                currentLocation : [1, 1],
                trail: [
                    [0, 1],
                    [0, 0]
                ]
            },
            {
                playerId: 2,
                direction: 'N',
                currentLocation : [2, 1],
                trail: [
                    [2, 2],
                    [1, 2]
                ]

            }
        ]
    };

    var stepLengthX = 600 / gameState.width;
    var stepLengthY = 600 / gameState.height;
    var offsetX = stepLengthX / 2;
    var offsetY = stepLengthY / 2;

    function getCanvasContext() {
        var ctx;
        var canvas = document.getElementById("canvas");
        if(canvas.getContext) {
            ctx = canvas.getContext("2d");
        }
        return ctx;
    }

    function draw() {
        var canvas = getCanvasContext();
        initCanvasStyle(canvas);
        gameState.bikes.forEach(function(bike) {
            drawBike(bike, findPlayerById(bike.playerId), canvas);
        });
    }

    function findPlayerById(playerId) {
        var player = players.currentPlayers.find(function (player) {
            return player.id  === playerId;
        });
        console.log(player);
        return player;
    }

    function initCanvasStyle(canvas) {
        canvas.lineWidth = calculateLineWidth();
        canvas.setLineDash([offsetX / 4, offsetX / 20]);
        canvas.shadowOffsetX = 0;
        canvas.shadowOffsetY = 0;
        canvas.shadowBlur = 75;
    }

    function initColorScheme(player, canvas) {
        canvas.strokeStyle = player.color;
        canvas.shadowColor = player.color;
        canvas.fillStyle = player.color;
    }

    function drawBike(bike, player, canvas) {
        initColorScheme(player, canvas);
        var startPosition = calculatePosition(bike.currentLocation);
        drawHead(bike.direction, startPosition, canvas);
        canvas.beginPath();
        canvas.moveTo(startPosition.x, startPosition.y);

        var oldPos = startPosition;
        bike.trail.forEach(function(trailEntry, index) {
            var position = calculatePosition(trailEntry);

            if(bike.trail.length > index + 1) {
                var nextPos = calculatePosition( bike.trail[index + 1]);
                if(!directionChanged(oldPos, nextPos)){
                    canvas.lineTo(position.x, position.y);
                }else{
                    canvas.quadraticCurveTo(position.x, position.y, nextPos.x, nextPos.y);
                }
            } else {
                canvas.lineTo(position.x, position.y);
            }
            oldPos = position;
        });
        canvas.stroke();
    }

    function drawHead(course, startPosition, canvas) {
        canvas.beginPath();
        if(course === 'N') {
            canvas.moveTo(startPosition.x, startPosition.y - offsetY);
            canvas.lineTo(startPosition.x + offsetX, startPosition.y);
            canvas.lineTo(startPosition.x - offsetX, startPosition.y);
        } else if (course === 'W') {
            canvas.moveTo(startPosition.x + offsetX, startPosition.y);
            canvas.lineTo(startPosition.x, startPosition.y + offsetY);
            canvas.lineTo(startPosition.x, startPosition.y - offsetY);
        } else if (course === 'E') {
            canvas.moveTo(startPosition.x - offsetX, startPosition.y);
            canvas.lineTo(startPosition.x, startPosition.y + offsetY);
            canvas.lineTo(startPosition.x, startPosition.y - offsetY);
        } else if (course === 'S') {
            canvas.moveTo(startPosition.x, startPosition.y + offsetY);
            canvas.lineTo(startPosition.x + offsetX, startPosition.y);
            canvas.lineTo(startPosition.x - offsetX, startPosition.y);
        } else {
            console.log('Hmmm!');
        }
        canvas.fill();
    }

    function directionChanged(oldPos, newPos) {
        return oldPos.x !== newPos.x && oldPos.y !== newPos.y;
    }


    function calculatePosition(location) {
        var pointX = location[0] * stepLengthX + offsetX;
        var pointY = location[1] * stepLengthY + offsetY;
        return {x: pointX, y: pointY};
    }

    function calculateLineWidth() {
        return offsetX;
    }

    function clear(canvas) {
        canvas.clear();
    }
</script>
</html>
